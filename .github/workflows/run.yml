name: Windows NoVNC (Self Hosted)

on:
  workflow_dispatch:
    inputs:
      password:
        description: "M·∫≠t kh·∫©u VNC"
        required: true
      duration:
        description: "Th·ªùi gian ch·∫°y (ph√∫t)"
        required: true
        default: "360"

jobs:
  build:
    runs-on: [self-hosted, windows]
    timeout-minutes: 380   # timeout c·ªë ƒë·ªãnh, duration d√πng cho keep-alive

    steps:
    - name: üîß Chu·∫©n b·ªã th∆∞ m·ª•c
      run: |
        if (Test-Path info.txt) { Remove-Item info.txt -Force }

    - name: üñ•Ô∏è Setup TightVNC + noVNC + Cloudflared + KeepAlive
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $durationMinutes = [int]"${{ inputs.duration }}"

        Write-Host "üì• Installing TightVNC, noVNC, and Cloudflared..."

        Write-Host "üì• Installing TightVNC..."
        Invoke-WebRequest -Uri "https://www.tightvnc.com/download/2.8.63/tightvnc-setup-64bit.msi" -OutFile "tightvnc-setup.msi" -TimeoutSec 60
        Write-Host "‚úÖ TightVNC downloaded"

        $pw = "${{ inputs.password }}"
        $args = @(
          '/i','tightvnc-setup.msi','/quiet','/norestart',
          'ADDLOCAL=Server','SERVER_REGISTER_AS_SERVICE=1','SERVER_ADD_FIREWALL_EXCEPTION=1',
          'SET_USEVNCAUTHENTICATION=1','VALUE_OF_USEVNCAUTHENTICATION=1','SET_PASSWORD=1',
          "VALUE_OF_PASSWORD=$pw",
          'SET_VIEWONLYPASSWORD=1',"VALUE_OF_VIEWONLYPASSWORD=$pw",
          'SET_ACCEPTHTTPCONNECTIONS=1','VALUE_OF_ACCEPTHTTPCONNECTIONS=1',
          'SET_ALLOWLOOPBACK=1','VALUE_OF_ALLOWLOOPBACK=1'
        )
        Start-Process msiexec.exe -Wait -ArgumentList $args
        Write-Host "‚úÖ TightVNC installed"

        Write-Host "üîß Configuring TightVNC..."
        New-Item -Path "HKLM:\SOFTWARE\TightVNC" -Name "Server" -Force | Out-Null
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AllowLoopback" -Value 1 -Type DWord -ErrorAction SilentlyContinue
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AlwaysShared" -Value 1 -Type DWord -ErrorAction SilentlyContinue
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "NeverShared" -Value 0 -Type DWord -ErrorAction SilentlyContinue
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "DisconnectAction" -Value 2 -Type DWord -ErrorAction SilentlyContinue
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "QueryIfNoLogon" -Value 0 -Type DWord -ErrorAction SilentlyContinue
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "QueryAcceptOnTimeout" -Value 1 -Type DWord -ErrorAction SilentlyContinue
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "QueryTimeout" -Value 10 -Type DWord -ErrorAction SilentlyContinue
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "RemoveWallpaper" -Value 0 -Type DWord -ErrorAction SilentlyContinue
        Write-Host "‚úÖ TightVNC configured"

        Write-Host "üîÑ Restarting TightVNC service..."
        Stop-Service -Name "tvnserver" -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 3
        Start-Service -Name "tvnserver" -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 10
        Write-Host "‚úÖ TightVNC service running"

        Write-Host "üîì Opening firewall ports..."
        netsh advfirewall firewall add rule name="Allow VNC 5900" dir=in action=allow protocol=TCP localport=5900 | Out-Null
        netsh advfirewall firewall add rule name="Allow noVNC 6080" dir=in action=allow protocol=TCP localport=6080 | Out-Null
        Write-Host "‚úÖ Firewall rules added"

        Write-Host "üì• Installing Python dependencies..."
        try {
          python -m pip install --upgrade pip --timeout 60
          pip install --force-reinstall numpy novnc websockify==0.13.0 --timeout 60
        } catch {
          Write-Host "‚ö†Ô∏è Python/pip kh√¥ng c√≥ s·∫µn ho·∫∑c c√†i dependency l·ªói: $_"
        }

        Write-Host "üì• Downloading noVNC..."
        $novncVersion = "v1.6.0"
        Remove-Item -Recurse -Force noVNC -ErrorAction SilentlyContinue
        $novncUrl = "https://github.com/novnc/noVNC/archive/refs/tags/$novncVersion.zip"
        Invoke-WebRequest -Uri $novncUrl -OutFile "noVNC.zip" -TimeoutSec 60
        Expand-Archive -Path "noVNC.zip" -DestinationPath "." -Force
        Move-Item -Path "noVNC-$($novncVersion.Substring(1))" -Destination "noVNC" -Force
        Write-Host "‚úÖ noVNC downloaded and extracted"

        Write-Host "üöÄ Starting websockify..."
        $websockify = $null
        try {
          $websockify = Start-Process -FilePath "python" -ArgumentList "-m","websockify","6080","127.0.0.1:5900","--web","noVNC","--verbose" -RedirectStandardOutput "websockify.log" -RedirectStandardError "websockify_error.log" -NoNewWindow -PassThru
        } catch {
          Write-Host "‚ö†Ô∏è Kh√¥ng ch·∫°y ƒë∆∞·ª£c websockify: $_"
        }
        Start-Sleep -Seconds 10

        Write-Host "üì• Downloading Cloudflared..."
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe" -TimeoutSec 60
        Write-Host "‚úÖ Cloudflared downloaded"

        function Start-Cloudflared {
          Write-Host "üåê Starting Cloudflared tunnel..."
          Start-Process -FilePath "cloudflared.exe" -ArgumentList "tunnel","--url","http://localhost:6080","--no-autoupdate","--edge-ip-version","auto","--protocol","http2","--logfile","cloudflared.log" -WindowStyle Hidden
        }

        Start-Cloudflared
        Start-Sleep -Seconds 15

        Write-Host "üöÄ Retrieving Cloudflared URL..."
        $maxAttempts = 120
        $attempt = 0
        $cloudflaredUrl = ""

        do {
          $attempt++
          Start-Sleep -Seconds 3

          if (Test-Path "cloudflared.log") {
            try {
              $logContent = Get-Content "cloudflared.log" -Raw -ErrorAction SilentlyContinue
              if ($logContent -match 'https://[a-zA-Z0-9-]+\.trycloudflare\.com') {
                $cloudflaredUrl = $matches[0]
                Write-Host "‚úÖ Found Cloudflared URL: $cloudflaredUrl"
                break
              }
            } catch {
              Write-Host "‚ö†Ô∏è Error reading cloudflared.log: $_"
            }
          }

          if (-not (Get-Process -Name "cloudflared" -ErrorAction SilentlyContinue)) {
            Write-Host "‚ö†Ô∏è Cloudflared process not found while getting URL, restarting..."
            Start-Cloudflared
            Start-Sleep -Seconds 10
          }
        } while ($attempt -lt $maxAttempts)

        if ($cloudflaredUrl) {
          "$cloudflaredUrl/vnc.html|${{ inputs.password }}" | Out-File -FilePath "info.txt" -Encoding UTF8 -NoNewline
          Write-Host "‚úÖ Remote VNC URL saved to info.txt"
        } else {
          "ERROR|Failed to retrieve Cloudflared URL" | Out-File -FilePath "info.txt" -Encoding UTF8 -NoNewline
          Write-Host "‚ùå Failed to get Cloudflared URL"
        }

        $ErrorActionPreference = "Continue"
        Write-Host "‚è≥ Entering keep-alive loop for $durationMinutes minutes..."
        for ($i = 1; $i -le $durationMinutes; $i++) {
          $currentTime = Get-Date -Format 'HH:mm:ss'
          Write-Host "üü¢ VPS Running - Minute $i/$durationMinutes ($currentTime)"

          try {
            if (-not (Get-Process -Name "cloudflared" -ErrorAction SilentlyContinue)) {
              Write-Host "‚ö†Ô∏è Cloudflared died during keep-alive, restarting..."
              Start-Cloudflared
            }
          } catch {
            Write-Host "‚ö†Ô∏è Error while checking/restarting Cloudflared: $_"
          }

          try {
            Invoke-WebRequest -Uri "http://localhost:6080" -UseBasicParsing -TimeoutSec 5 | Out-Null
          } catch {
            Write-Host "‚ö†Ô∏è noVNC/websockify not responding, trying to restart..."
            try {
              if ($websockify -and (Get-Process -Id $websockify.Id -ErrorAction SilentlyContinue)) {
                Stop-Process -Id $websockify.Id -Force -ErrorAction SilentlyContinue
              }
            } catch {}
            try {
              $websockify = Start-Process -FilePath "python" -ArgumentList "-m","websockify","6080","127.0.0.1:5900","--web","noVNC","--verbose" -RedirectStandardOutput "websockify.log" -RedirectStandardError "websockify_error.log" -NoNewWindow -PassThru
            } catch {
              Write-Host "‚ö†Ô∏è Kh√¥ng restart ƒë∆∞·ª£c websockify: $_"
            }
          }

          Start-Sleep -Seconds 60
        }

        Write-Host "‚è∞ VPS session time limit reached - exiting job."

    - name: üì§ Upload info.txt
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: result
        path: info.txt
