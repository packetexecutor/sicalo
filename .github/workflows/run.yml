name: Linux NoVNC (Enhanced)
on:
  workflow_dispatch:
    inputs:
      password:
        required: true
      duration:
        required: true
        default: "360"

jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: ${{ inputs.duration }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: üì¶ Install Desktop Environment
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tigervnc-standalone-server python3-websockify curl
        git clone https://github.com/novnc/noVNC.git
    
    - name: üöÄ Start VNC + noVNC
      run: |
        mkdir -p ~/.vnc
        echo "${{ inputs.password }}" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        vncserver :1 -geometry 1920x1080 -depth 24
        ./noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 6080 &
        sleep 5
        
    - name: üåê Setup Cloudflared
      run: |
        curl -L --output cloudflared-linux-amd64.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
        sleep 15

    - name: üì§ Export Info
      run: |
        URL=$(grep -o 'https://.*.trycloudflare.com' tunnel.log | head -n 1)
        if [ -z "$URL" ]; then
          echo "ERROR|Failed to get Cloudflared URL" > info.txt
        else
          echo "$URL/vnc.html|${{ inputs.password }}" > info.txt
        fi

    - uses: actions/upload-artifact@v4
      with:
        name: result
        path: info.txt

    - name: ‚è≥ Keep Alive + Auto Restart
      run: |
        total=${{ inputs.duration }}
        for ((i=1; i<=total; i++)); do
          date +"üü¢ VPS running - minute %M (%H:%M:%S)"
          pgrep cloudflared >/dev/null || {
            echo "‚ö†Ô∏è Cloudflared died, restarting..."
            cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          }
          sleep 60
        done
